<div class="row"> 
  <div class="col s6 offset-s3">
    <h1> Your Package Details </h1> 
  </div>
</div>

<div class="row"> 
  <div class="col s6 offset-s3">
    <h1> <%= @package.title %></h1>
    
    <div class="status"> 

      Status:
      <% if @package.driver_id.nil? %>
        Ready for Pickup 

        <% if @current_user.type == "Driver" %>
          <form id="state_form" onsubmit="return youCanSubmitNow()" method="post" action="/packages/<%=@package.id %>">
            <input type="hidden" name="event" value="assign">
            <input id="lat" type="hidden" name="latitude">
            <input id="lon" type="hidden" name="longitude">
            <input id="accept" type="submit" value="Accept this Delivery">
          </form>
        <% end %> 

      <% elsif @package.driver_id && @package.pick_up_time.nil? %>
        Accepted at <%= @package.assigned_time.strftime('%c') %>

        <% if @current_user.type == "Driver" %>
          <form id="state_form_cancel" onsubmit="return youCanSubmitNow(this)" method="post" action="/packages/<%=@package.id %>">
            <input type="hidden" name="event" value="cancel">
            <input id="lat" type="hidden" name="latitude">
            <input id="lon" type="hidden" name="longitude">
            <input id="cancel" type="submit" value="Cancel this Delivery">
          </form>
        <% end %> 

        <% if @current_user.type == "Driver" %>
          <form id="state_form_picked_up" onsubmit="return youCanSubmitNow(this)" method="post" action="/packages/<%=@package.id %>">
          <input type="hidden" name="event" value="picked_up">
          <input id="lat" type="hidden" name="latitude">
          <input id="lon" type="hidden" name="longitude">
          <input id="picked" type="submit" value="Picked Up">
        </form>
        <% end %>

      <% elsif  @package.pick_up_time && @package.delivery_time.nil? %>
        Picked Up at <%= @package.pick_up_time %>

        <% if @current_user.type == "Driver" %> 
          <form id="state_form" onsubmit="return youCanSubmitNow(this)" method="post" action="/packages/<%=@package.id %>">
            <input type="hidden" name="event" value="delivered">
            <input id="lat" type="hidden" name="latitude">
            <input id="lon" type="hidden" name="longitude">
            <input id="delivered" type="submit" value="Delivered">
          </form>
        <% end %> 

      <% elsif  @package.delivery_time %> 
        Delivered at <%= @package.delivery_time %>

      <% end %> 

    </div>
  
    <ul> 
      <li> Recipient: <%= @package.recipient %> </li>
      <li> Origin: <%= @package.origin %> </li>
      <li> Destination: <%= @package.destination %> </li>
      <li> Dimensions (L x W x H): <%= @package.length %> x <%= @package.width %> x <%= @package.height %> </li>
      <li> Notes: <%= @package.notes %> </li>
    </ul>

    <!-- For drivers only! Add map to show the origin and destination of the package, also the current location of the driver -->
    <div>
    <% if @current_user.type == "Driver" %>
      <%= erb :'/packages/O-D_map' %>
    <% end %>
    </div>

    
    <% if @current_user.type == "Customer" %>

      <a href='/packages/<%=@package.id %>/edit'> Edit Your Package Details </a>

      <% if @package.driver_id.nil? %> 
        Your package has not been accepted yet. You may still cancel your delivery. 
        <br/> 
        <form method="post" action="/packages/<%=@package.id %>">
          <input type="hidden" name="_method" value="delete">
          <input id="lat" type="hidden" name="latitude">
          <input id="lon" type="hidden" name="longitude">  
          <input type="submit" value="Delete Package">
        </form>
      <% end %>
      
      <div> 
        <h1> Your Driver's Information </h1>

        Driver ID: <%= @package.driver_id%> 
        <% if @driver %> 
          <%= @driver.first_name %>
        <% end %> 

      </div>

    <% end %>
  
  </div>
</div>

<script type="text/javascript">
  var form;
  var button = document.getElementById('accept');
  button.addEventListener('click', function (el) {
    getLocation();
    // console.log('accept button clicked!');
  });  

  function savePositionInDB(pos) {
    // console.log('SAVINGS!!!');
    // console.log(pos);

    // submit!!!  Or send info to database
    var input_lat = document.getElementById('lat');
    var input_lon = document.getElementById('lon');
    input_lat.value = pos.coords.latitude;
    input_lon.value = pos.coords.longitude;

    // console.log('lat: ' + pos.coords.latitude + 'and lon: ' + pos.coords.longitude);
    console.log(form);
    form.submit();
    // return true;
  }

  function youCanSubmitNow(aForm) {
    form = aForm;
    getLocation();
    return false;
  }

  function onPositionError(err) {
    // console.log(err.message);
    console.log('in position error!');
  }

  function getLocation() {
    // console.log('getLocation called!');
    if (navigator.geolocation) {
      // console.log("geolocation supported!!!");
      navigator.geolocation.getCurrentPosition(
        savePositionInDB, 
        onPositionError
      );
    } else {
      var p = document.createElement("P");
      var map_container = document.getElementById("map_container");
      p.innerHTML = "Geolocation is not supported by this browser: " + status;
      map_container.appendChild(p);
      // x.innerHTML = "Geolocation is not supported by this browser.";
    }
  }

</script>
    
 
